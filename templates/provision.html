{% extends "base.html" %}

{% block title %}Provision Hikvision User{% endblock %}

{% block content %}
<div class="card">
    <h2>Add User To Devices</h2>
    <form action="{{ request.url }}" method="post" enctype="multipart/form-data">
        <div>
            <label for="user_id">User ID</label><br>
            <input type="text" id="user_id" name="user_id" value="{{ form.user_id }}" required>
        </div>
        <div>
            <label for="name">Name</label><br>
            <input type="text" id="name" name="name" value="{{ form.name }}" required>
        </div>
        <div>
            <label for="face">Face image</label><br>
            <input type="file" id="face" name="face" accept="image/*" required>
        </div>
        <div>
            <label for="device_ids">Devices</label><br>
            <select id="device_ids" name="device_ids" multiple size="5" required>
                {% for device in devices %}
                <option value="{{ device.id }}" {% if device.id in form.device_ids %}selected{% endif %}>
                    {{ device.name }} ({{ device.ip }})
                </option>
                {% endfor %}
            </select>
            <p>Select one or more devices (Ctrl/Cmd + click).</p>
        </div>
        {% if errors %}
        <div style="color: #b02a37;">
            <ul>
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        <div>
            <button type="submit">Provision User</button>
        </div>
    </form>

    {% if results %}
    <hr>
    <h3>Results</h3>
    <ul>
        {% for item in results %}
        <li>
            {{ item.device.name }} ({{ item.device.ip }}):
            {% if item.status == "success" %}
                ✅ Success
            {% else %}
                ❌ Failed - {{ item.message }}
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {% endif %}
</div>
{% endblock %}

